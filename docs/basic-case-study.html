<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 4 Case study: ER injuries | Mastering Shiny</title>
<meta name="author" content="Hadley Wickham">
<meta name="generator" content="bookdown 0.34.2 with bs4_book()">
<meta property="og:title" content="Chapter 4 Case study: ER injuries | Mastering Shiny">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 4 Case study: ER injuries | Mastering Shiny">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.0/transition.js"></script><script src="libs/bs3compat-0.5.0/tabs.js"></script><script src="libs/bs3compat-0.5.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141197094-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-141197094-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<meta name="description" content="4.1 Introduction I’ve introduced you to a bunch of new concepts in the last three chapters. So to help them sink in, we’ll now walk through a richer Shiny app that explores a fun dataset and pulls...">
<meta property="og:description" content="4.1 Introduction I’ve introduced you to a bunch of new concepts in the last three chapters. So to help them sink in, we’ll now walk through a richer Shiny app that explores a fun dataset and pulls...">
<meta name="twitter:description" content="4.1 Introduction I’ve introduced you to a bunch of new concepts in the last three chapters. So to help them sink in, we’ll now walk through a richer Shiny app that explores a fun dataset and pulls...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Mastering Shiny</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Getting started</li>
<li><a class="" href="basic-intro.html">Introduction</a></li>
<li><a class="" href="basic-app.html"><span class="header-section-number">1</span> Your first Shiny app</a></li>
<li><a class="" href="basic-ui.html"><span class="header-section-number">2</span> Basic UI</a></li>
<li><a class="" href="basic-reactivity.html"><span class="header-section-number">3</span> Basic reactivity</a></li>
<li><a class="active" href="basic-case-study.html"><span class="header-section-number">4</span> Case study: ER injuries</a></li>
<li class="book-part">Shiny in action</li>
<li><a class="" href="action-intro.html">Introduction</a></li>
<li><a class="" href="action-workflow.html"><span class="header-section-number">5</span> Workflow</a></li>
<li><a class="" href="action-layout.html"><span class="header-section-number">6</span> Layout, themes, HTML</a></li>
<li><a class="" href="action-graphics.html"><span class="header-section-number">7</span> Graphics</a></li>
<li><a class="" href="action-feedback.html"><span class="header-section-number">8</span> User feedback</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/mastering-shiny">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="basic-case-study" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Case study: ER injuries<a class="anchor" aria-label="anchor" href="#basic-case-study"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-3" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-3"><i class="fas fa-link"></i></a>
</h2>
<p>I’ve introduced you to a bunch of new concepts in the last three chapters.
So to help them sink in, we’ll now walk through a richer Shiny app that explores a fun dataset and pulls together many of the ideas that you’ve seen so far.
We’ll start by doing a little data analysis outside of Shiny, then turn it into an app, starting simply, then progressively layering on more detail.</p>
<p>In this chapter, we’ll supplement Shiny with vroom (for fast file reading) and the tidyverse (for general data analysis).</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://vroom.r-lib.org">vroom</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'vroom' was built under R version 4.2.3</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'tidyverse' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'ggplot2' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'tibble' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'tidyr' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'readr' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'purrr' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'dplyr' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'stringr' was built under R version 4.2.2</span></span>
<span><span class="co">#&gt; Warning: package 'forcats' was built under R version 4.2.3</span></span>
<span><span class="co">#&gt; Warning: package 'lubridate' was built under R version 4.2.3</span></span></code></pre></div>
</div>
<div id="the-data" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> The data<a class="anchor" aria-label="anchor" href="#the-data"><i class="fas fa-link"></i></a>
</h2>
<p>We’re going to explore data from the National Electronic Injury Surveillance System (NEISS), collected by the Consumer Product Safety Commission.
This is a long-term study that records all accidents seen in a representative sample of hospitals in the United States.
It’s an interesting dataset to explore because every one is already familiar with the domain, and each observation is accompanied by a short narrative that explains how the accident occurred.
You can find out more about this dataset at <a href="https://github.com/hadley/neiss" class="uri">https://github.com/hadley/neiss</a>.</p>
<p>In this chapter, I’m going to focus on just the data from 2017.
This keeps the data small enough (~10 MB) that it’s easy to store in git (along with the rest of the book), which means we don’t need to think about sophisticated strategies for importing the data quickly (we’ll come back to those later in the book).
You can see the code I used to create the extract for this chapter at <a href="https://github.com/hadley/mastering-shiny/blob/master/neiss/data.R" class="uri">https://github.com/hadley/mastering-shiny/blob/master/neiss/data.R</a>.</p>
<p>If you want to get the data on to your own computer, run this code:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="st">"neiss"</span><span class="op">)</span></span>
<span><span class="va">download</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://github.com/hadley/mastering-shiny/blob/main/neiss/"</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">name</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"neiss/"</span>, <span class="va">name</span><span class="op">)</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">download</span><span class="op">(</span><span class="st">"injuries.tsv.gz"</span><span class="op">)</span></span>
<span><span class="fu">download</span><span class="op">(</span><span class="st">"population.tsv"</span><span class="op">)</span></span>
<span><span class="fu">download</span><span class="op">(</span><span class="st">"products.tsv"</span><span class="op">)</span></span></code></pre></div>
<p>The main dataset we’ll use is <code>injuries</code>, which contains around 250,000 observations:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">injuries</span> <span class="op">&lt;-</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op">(</span><span class="st">"neiss/injuries.tsv.gz"</span><span class="op">)</span></span>
<span><span class="va">injuries</span></span>
<span><span class="co">#&gt; # A tibble: 255,064 × 10</span></span>
<span><span class="co">#&gt;   trmt_date    age sex   race  body_part   diag         location prod_code weight</span></span>
<span><span class="co">#&gt;   &lt;date&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 2017-01-01    71 male  white Upper Trunk Contusion O… Other P…      1807   77.7</span></span>
<span><span class="co">#&gt; 2 2017-01-01    16 male  white Lower Arm   Burns, Ther… Home           676   77.7</span></span>
<span><span class="co">#&gt; 3 2017-01-01    58 male  white Upper Trunk Contusion O… Home           649   77.7</span></span>
<span><span class="co">#&gt; 4 2017-01-01    21 male  white Lower Trunk Strain, Spr… Home          4076   77.7</span></span>
<span><span class="co">#&gt; 5 2017-01-01    54 male  white Head        Inter Organ… Other P…      1807   77.7</span></span>
<span><span class="co">#&gt; 6 2017-01-01    21 male  white Hand        Fracture     Home          1884   77.7</span></span>
<span><span class="co">#&gt; # ℹ 255,058 more rows</span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: narrative &lt;chr&gt;</span></span></code></pre></div>
<p>Each row represents a single accident with 10 variables:</p>
<ul>
<li><p><code>trmt_date</code> is date the person was seen in the hospital (not when the accident occurred).</p></li>
<li><p><code>age</code>, <code>sex</code>, and <code>race</code> give demographic information about the person who experienced the accident.</p></li>
<li><p><code>body_part</code> is the location of the injury on the body (like ankle or ear); <code>location</code> is the place where the accident occurred (like home or school).</p></li>
<li><p><code>diag</code> gives the basic diagnosis of the injury (like fracture or laceration).</p></li>
<li><p><code>prod_code</code> is the primary product associated with the injury.</p></li>
<li><p><code>weight</code> is statistical weight giving the estimated number of people who would suffer this injury if this dataset was scaled to the entire population of the US.</p></li>
<li><p><code>narrative</code> is a brief story about how the accident occurred.</p></li>
</ul>
<p>We’ll pair it with two other data frames for additional context: <code>products</code> lets us look up the product name from the product code, and <code>population</code> tells us the total US population in 2017 for each combination of age and sex.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">products</span> <span class="op">&lt;-</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op">(</span><span class="st">"neiss/products.tsv"</span><span class="op">)</span></span>
<span><span class="va">products</span></span>
<span><span class="co">#&gt; # A tibble: 38 × 2</span></span>
<span><span class="co">#&gt;   prod_code title                            </span></span>
<span><span class="co">#&gt;       &lt;dbl&gt; &lt;chr&gt;                            </span></span>
<span><span class="co">#&gt; 1       464 knives, not elsewhere classified </span></span>
<span><span class="co">#&gt; 2       474 tableware and accessories        </span></span>
<span><span class="co">#&gt; 3       604 desks, chests, bureaus or buffets</span></span>
<span><span class="co">#&gt; 4       611 bathtubs or showers              </span></span>
<span><span class="co">#&gt; 5       649 toilets                          </span></span>
<span><span class="co">#&gt; 6       676 rugs or carpets, not specified   </span></span>
<span><span class="co">#&gt; # ℹ 32 more rows</span></span>
<span></span>
<span><span class="va">population</span> <span class="op">&lt;-</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op">(</span><span class="st">"neiss/population.tsv"</span><span class="op">)</span></span>
<span><span class="va">population</span></span>
<span><span class="co">#&gt; # A tibble: 170 × 3</span></span>
<span><span class="co">#&gt;     age sex    population</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     0 female    1924145</span></span>
<span><span class="co">#&gt; 2     0 male      2015150</span></span>
<span><span class="co">#&gt; 3     1 female    1943534</span></span>
<span><span class="co">#&gt; 4     1 male      2031718</span></span>
<span><span class="co">#&gt; 5     2 female    1965150</span></span>
<span><span class="co">#&gt; 6     2 male      2056625</span></span>
<span><span class="co">#&gt; # ℹ 164 more rows</span></span></code></pre></div>
</div>
<div id="exploration" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Exploration<a class="anchor" aria-label="anchor" href="#exploration"><i class="fas fa-link"></i></a>
</h2>
<p>Before we create the app, let’s explore the data a little.
We’ll start by looking at a product with an interesting story: 649, “toilets”.
First we’ll pull out the injuries associated with this product:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selected</span> <span class="op">&lt;-</span> <span class="va">injuries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">prod_code</span> <span class="op">==</span> <span class="fl">649</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2993</span></span></code></pre></div>
<p>Next we’ll perform some basic summaries looking at the location, body part, and diagnosis of toilet related injuries.
Note that I weight by the <code>weight</code> variable so that the counts can be interpreted as estimated total injuries across the whole US.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">location</span>, wt <span class="op">=</span> <span class="va">weight</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 2</span></span>
<span><span class="co">#&gt;   location                         n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                        &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Home                       99603. </span></span>
<span><span class="co">#&gt; 2 Other Public Property      18663. </span></span>
<span><span class="co">#&gt; 3 Unknown                    16267. </span></span>
<span><span class="co">#&gt; 4 School                       659. </span></span>
<span><span class="co">#&gt; 5 Street Or Highway             16.2</span></span>
<span><span class="co">#&gt; 6 Sports Or Recreation Place    14.8</span></span>
<span></span>
<span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">body_part</span>, wt <span class="op">=</span> <span class="va">weight</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 24 × 2</span></span>
<span><span class="co">#&gt;   body_part        n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Head        31370.</span></span>
<span><span class="co">#&gt; 2 Lower Trunk 26855.</span></span>
<span><span class="co">#&gt; 3 Face        13016.</span></span>
<span><span class="co">#&gt; 4 Upper Trunk 12508.</span></span>
<span><span class="co">#&gt; 5 Knee         6968.</span></span>
<span><span class="co">#&gt; 6 N.S./Unk     6741.</span></span>
<span><span class="co">#&gt; # ℹ 18 more rows</span></span>
<span></span>
<span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">diag</span>, wt <span class="op">=</span> <span class="va">weight</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 20 × 2</span></span>
<span><span class="co">#&gt;   diag                       n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Other Or Not Stated   32897.</span></span>
<span><span class="co">#&gt; 2 Contusion Or Abrasion 22493.</span></span>
<span><span class="co">#&gt; 3 Inter Organ Injury    21525.</span></span>
<span><span class="co">#&gt; 4 Fracture              21497.</span></span>
<span><span class="co">#&gt; 5 Laceration            18734.</span></span>
<span><span class="co">#&gt; 6 Strain, Sprain         7609.</span></span>
<span><span class="co">#&gt; # ℹ 14 more rows</span></span></code></pre></div>
<p>As you might expect, injuries involving toilets most often occur at home.
The most common body parts involved possibly suggest that these are falls (since the head and face are not usually involved in routine toilet usage), and the diagnoses seem rather varied.</p>
<p>We can also explore the pattern across age and sex.
We have enough data here that a table is not that useful, and so I make a plot, Figure <a href="basic-case-study.html#fig:toilets-raw">4.1</a>, that makes the patterns more obvious.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary</span> <span class="op">&lt;-</span> <span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">sex</span>, wt <span class="op">=</span> <span class="va">weight</span><span class="op">)</span></span>
<span><span class="va">summary</span></span>
<span><span class="co">#&gt; # A tibble: 208 × 3</span></span>
<span><span class="co">#&gt;     age sex         n</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     0 female   4.76</span></span>
<span><span class="co">#&gt; 2     0 male    14.3 </span></span>
<span><span class="co">#&gt; 3     1 female 253.  </span></span>
<span><span class="co">#&gt; 4     1 male   231.  </span></span>
<span><span class="co">#&gt; 5     2 female 438.  </span></span>
<span><span class="co">#&gt; 6     2 male   632.  </span></span>
<span><span class="co">#&gt; # ℹ 202 more rows</span></span>
<span></span>
<span><span class="va">summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">n</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Estimated number of injuries"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:toilets-raw"></span>
<img src="basic-case-study_files/figure-html/toilets-raw-1.png" alt="Estimated number of injuries caused by toilets, broken down by age and sex" width="100%"><p class="caption">
Figure 4.1: Estimated number of injuries caused by toilets, broken down by age and sex
</p>
</div>
<p>We see a spike for young boys peaking at age 3, and then an increase (particularly for women) starting around middle age, and a gradual decline after age 80.
I suspect the peak is because boys usually use the toilet standing up, and the increase for women is due to osteoporosis (i.e. I suspect women and men have injuries at the same rate, but more women end up in the ER because they are at higher risk of fractures).</p>
<p>One problem with interpreting this pattern is that we know that there are fewer older people than younger people, so the population available to be injured is smaller.
We can control for this by comparing the number of people injured with the total population and calculating an injury rate.
Here I use a rate per 10,000.</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary</span> <span class="op">&lt;-</span> <span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">sex</span>, wt <span class="op">=</span> <span class="va">weight</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">population</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"sex"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="va">population</span> <span class="op">*</span> <span class="fl">1e4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">summary</span></span>
<span><span class="co">#&gt; # A tibble: 208 × 5</span></span>
<span><span class="co">#&gt;     age sex         n population   rate</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     0 female   4.76    1924145 0.0247</span></span>
<span><span class="co">#&gt; 2     0 male    14.3     2015150 0.0708</span></span>
<span><span class="co">#&gt; 3     1 female 253.      1943534 1.30  </span></span>
<span><span class="co">#&gt; 4     1 male   231.      2031718 1.14  </span></span>
<span><span class="co">#&gt; 5     2 female 438.      1965150 2.23  </span></span>
<span><span class="co">#&gt; 6     2 male   632.      2056625 3.07  </span></span>
<span><span class="co">#&gt; # ℹ 202 more rows</span></span></code></pre></div>
<p>Plotting the rate, Figure <a href="basic-case-study.html#fig:toilets-rate">4.2</a>, yields a strikingly different trend after age 50: the difference between men and women is much smaller, and we no longer see a decrease.
This is because women tend to live longer than men, so at older ages there are simply more women alive to be injured by toilets.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">rate</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Injuries per 10,000 people"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:toilets-rate"></span>
<img src="basic-case-study_files/figure-html/toilets-rate-1.png" alt="Estimated rate of injuries per 10,000 people, broken down by age and sex" width="100%"><p class="caption">
Figure 4.2: Estimated rate of injuries per 10,000 people, broken down by age and sex
</p>
</div>
<p>(Note that the rates only go up to age 80 because I couldn’t find population data for ages over 80.)</p>
<p>Finally, we can look at some of the narratives.
Browsing through these is an informal way to check our hypotheses, and generate new ideas for further exploration.
Here I pull out a random sample of 10:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selected</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_n</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">narrative</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "53YF FELL WHILE TX'ING SELF FROM WHEELCHAIR TO THE TOILETC/O&gt;&gt;LEG PAIN"                                                                        </span></span>
<span><span class="co">#&gt;  [2] "85YOF POST FALL EVAL,PER DAUGHTER PT WAS GETTING UP FROM TOILET,WENT TOREACH FOR HANDRAIL,MISSED FELL BW'S HIT BK HD ,NO THIN,LOC DXHD INJURY,"</span></span>
<span><span class="co">#&gt;  [3] "90 YOF. SIITING ON THE TOILET WHEN PT HAD A SYNCOPAL EPISODE &amp; FELL TOTHE FLOOR. DX: SYNCOPE"                                                  </span></span>
<span><span class="co">#&gt;  [4] "83 YOF FELL WHILE HUSBAND WAS HELPING HER TRANSFER OFF OF TOILET.DX:  CERVICAL STRAIN, DEMENTIA, POSS UTI."                                    </span></span>
<span><span class="co">#&gt;  [5] "87YO F WAS TRANSFERRING TO TOILET 2 DAYS AGO WHEN SHE FELL FORWARD. RIBPAIN. DX:CLOSED FX, MULTIPLE RIBS. TRANSFER."                           </span></span>
<span><span class="co">#&gt;  [6] "85 YOF FROM NURSING FACILITY WAS GETTING UP FROM TOILET MISSED HANDRAILAND FELL ONTO LEFT SIDE C/O HIP, THIGH, CHEST PAIN DX FEMUR FX, RIB FX" </span></span>
<span><span class="co">#&gt;  [7] "69YOF TRYING TO TRANSFER SELF FROM THE WHEELCHAIR TO THE TOILET AND KNEE POPPED OUT OF PLACE DISLOCATED KNEE"                                  </span></span>
<span><span class="co">#&gt;  [8] "81YM H/O HIP REPLACEMENT, FROM ALF WHERE ATTEMPTED TO GET UP OFF TOILET, LEGS GAVE OUT&amp;FELL&gt;&gt;FEMUR FX"                                         </span></span>
<span><span class="co">#&gt;  [9] "93YOF SITTING ON TOILET, WENT TO STAND &amp; FELL OVER HITTING HEAD 2 ASSTLIVING  DX: ORTHOSTATIC SYNCOPE,FACIAL LAC, AKI, HYPERKALEMIA"           </span></span>
<span><span class="co">#&gt; [10] "69 YOF GETTING OFF COMMODE &amp; SLIPPED, PROSTHETIC HIP POPPED OUT C/O PAIN DX HIP PROSTHESIS DISLOCATION"</span></span></code></pre></div>
<p>Having done this exploration for one product, it would be very nice if we could easily do it for other products, without having to retype the code.
So let’s make a Shiny app!</p>
</div>
<div id="prototype" class="section level2" number="4.4">
<h2>
<span class="header-section-number">4.4</span> Prototype<a class="anchor" aria-label="anchor" href="#prototype"><i class="fas fa-link"></i></a>
</h2>
<p>When building a complex app, I strongly recommend starting as simple as possible, so that you can confirm the basic mechanics work before you start doing something more complicated.
Here I’ll start with one input (the product code), three tables, and one plot.</p>
<p>When designing a first prototype, the challenge is in making it “as simple <em>as possible</em>”.
There’s a tension between getting the basics working quickly and planning for the future of the app.
Either extreme can be bad: if you design too narrowly, you’ll spend a lot of time later on reworking your app; if you design too rigorously, you’ll spend a bunch of time writing code that later ends up on the cutting floor.
To help get the balance right, I often do a few pencil-and-paper sketches to rapidly explore the UI and reactive graph before committing to code.</p>
<p>Here I decided to have one row for the inputs (accepting that I’m probably going to add more inputs before this app is done), one row for all three tables (giving each table 4 columns, 1/3 of the 12 column width), and then one row for the plot:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prod_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">products</span><span class="op">$</span><span class="va">prod_code</span>, <span class="va">products</span><span class="op">$</span><span class="va">title</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">6</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput</a></span><span class="op">(</span><span class="st">"code"</span>, <span class="st">"Product"</span>, choices <span class="op">=</span> <span class="va">prod_codes</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">tableOutput</a></span><span class="op">(</span><span class="st">"diag"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">tableOutput</a></span><span class="op">(</span><span class="st">"body_part"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">tableOutput</a></span><span class="op">(</span><span class="st">"location"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="st">"age_sex"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We haven’t talked about <code><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow()</a></code> and <code><a href="https://rdrr.io/pkg/shiny/man/column.html">column()</a></code> yet, but you should be able to guess what they do from the context, and we’ll come back to talk about them in Section <a href="action-layout.html#multi-row">6.2.3</a>.
Also note the use of <code><a href="https://rdrr.io/r/stats/setNames.html">setNames()</a></code> in the <code><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput()</a></code> <code>choices</code>: this shows the product name in the UI and returns the product code to the server.</p>
<p>The server function is relatively straightforward.
I first convert the <code>selected</code> and <code>summary</code> variables created in the previous section to reactive expressions.
This is a reasonable general pattern: you create variables in your data analysis to decompose the analysis into steps, and to avoid recomputing things multiple times, and reactive expressions play the same role in Shiny apps.</p>
<p>Often it’s a good idea to spend a little time cleaning up your analysis code before you start your Shiny app, so you can think about these problems in regular R code, before you add the additional complexity of reactivity.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">selected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="va">injuries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">prod_code</span> <span class="op">==</span> <span class="va">input</span><span class="op">$</span><span class="va">code</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">renderTable</a></span><span class="op">(</span></span>
<span>    <span class="fu">selected</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">diag</span>, wt <span class="op">=</span> <span class="va">weight</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">body_part</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">renderTable</a></span><span class="op">(</span></span>
<span>    <span class="fu">selected</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">body_part</span>, wt <span class="op">=</span> <span class="va">weight</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">renderTable</a></span><span class="op">(</span></span>
<span>    <span class="fu">selected</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">location</span>, wt <span class="op">=</span> <span class="va">weight</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">selected</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">sex</span>, wt <span class="op">=</span> <span class="va">weight</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">population</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"sex"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="va">population</span> <span class="op">*</span> <span class="fl">1e4</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">age_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">n</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Estimated number of injuries"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that creating the <code>summary</code> reactive isn’t strictly necessary here, as it’s only used by a single reactive consumer.
But it’s good practice to keep computing and plotting separate as it makes the flow of the app easier to understand, and will make it easier to generalise in the future.</p>
<p>A screenshot of the resulting app is shown in Figure <a href="basic-case-study.html#fig:prototype">4.3</a>.
You can find the source code at <a href="https://github.com/hadley/mastering-shiny/tree/main/neiss/prototype.R" class="uri">https://github.com/hadley/mastering-shiny/tree/main/neiss/prototype.R</a> and try out a live version of the app at <a href="https://hadley.shinyapps.io/ms-prototype/" class="uri">https://hadley.shinyapps.io/ms-prototype/</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:prototype"></span>
<img src="demos/basic-case-study/prototype.png" alt="First prototype of NEISS exploration app" width="100%"><p class="caption">
Figure 4.3: First prototype of NEISS exploration app
</p>
</div>
</div>
<div id="polish-tables" class="section level2" number="4.5">
<h2>
<span class="header-section-number">4.5</span> Polish tables<a class="anchor" aria-label="anchor" href="#polish-tables"><i class="fas fa-link"></i></a>
</h2>
<p>Now that we have the basic components in place and working, we can progressively improve our app.
The first problem with this app is that it shows a lot of information in the tables, where we probably just want the highlights.
To fix this we need to first figure out how to truncate the tables.
I’ve chosen to do that with a combination of forcats functions: I convert the variable to a factor, order by the frequency of the levels, and then lump together all levels after the top 5.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">injuries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diag <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_lump.html">fct_lump</a></span><span class="op">(</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_infreq</a></span><span class="op">(</span><span class="va">diag</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">diag</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 2</span></span>
<span><span class="co">#&gt;   diag                        n</span></span>
<span><span class="co">#&gt;   &lt;fct&gt;                   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 Other Or Not Stated   1806436</span></span>
<span><span class="co">#&gt; 2 Fracture              1558961</span></span>
<span><span class="co">#&gt; 3 Laceration            1432407</span></span>
<span><span class="co">#&gt; 4 Strain, Sprain        1432556</span></span>
<span><span class="co">#&gt; 5 Contusion Or Abrasion 1451987</span></span>
<span><span class="co">#&gt; 6 Other                 1929147</span></span></code></pre></div>
<p>Because I knew how to do it, I wrote a little function to automate this for any variable.
The details aren’t really important here, but we’ll come back to them in Chapter <a href="#action-tidy"><strong>??</strong></a>.
You could also solve the problem with copy and paste, so don’t worry if the code looks totally foreign.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">count_top</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">var</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">var</span> <span class="op">}</span><span class="op">}</span> <span class="op">:=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_lump.html">fct_lump</a></span><span class="op">(</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_infreq</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">var</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span>, n <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">var</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">weight</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>I then use this in the server function:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">output</span><span class="op">$</span><span class="va">diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">renderTable</a></span><span class="op">(</span><span class="fu">count_top</span><span class="op">(</span><span class="fu">selected</span><span class="op">(</span><span class="op">)</span>, <span class="va">diag</span><span class="op">)</span>, width <span class="op">=</span> <span class="st">"100%"</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">body_part</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">renderTable</a></span><span class="op">(</span><span class="fu">count_top</span><span class="op">(</span><span class="fu">selected</span><span class="op">(</span><span class="op">)</span>, <span class="va">body_part</span><span class="op">)</span>, width <span class="op">=</span> <span class="st">"100%"</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderTable.html">renderTable</a></span><span class="op">(</span><span class="fu">count_top</span><span class="op">(</span><span class="fu">selected</span><span class="op">(</span><span class="op">)</span>, <span class="va">location</span><span class="op">)</span>, width <span class="op">=</span> <span class="st">"100%"</span><span class="op">)</span></span></code></pre></div>
<p>I made one other change to improve the aesthetics of the app: I forced all tables to take up the maximum width (i.e. fill the column that they appear in).
This makes the output more aesthetically pleasing because it reduces the amount of incidental variation.</p>
<p>A screenshot of the resulting app is shown in Figure <a href="basic-case-study.html#fig:polish-tables">4.4</a>.
You can find the source code at <a href="https://github.com/hadley/mastering-shiny/tree/main/neiss/polish-tables.R" class="uri">https://github.com/hadley/mastering-shiny/tree/main/neiss/polish-tables.R</a> and try out a live version of the app at <a href="https://hadley.shinyapps.io/ms-polish-tables" class="uri">https://hadley.shinyapps.io/ms-polish-tables</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:polish-tables"></span>
<img src="demos/basic-case-study/polish-tables.png" alt="The second iteration of the app improves the display by only showing the most frequent rows in the summary tables" width="100%"><p class="caption">
Figure 4.4: The second iteration of the app improves the display by only showing the most frequent rows in the summary tables
</p>
</div>
</div>
<div id="rate-vs-count" class="section level2" number="4.6">
<h2>
<span class="header-section-number">4.6</span> Rate vs count<a class="anchor" aria-label="anchor" href="#rate-vs-count"><i class="fas fa-link"></i></a>
</h2>
<p>So far, we’re displaying only a single plot, but we’d like to give the user the choice between visualising the number of injuries or the population-standardised rate.
First I add a control to the UI.
Here I’ve chosen to use a <code><a href="https://rdrr.io/pkg/shiny/man/selectInput.html">selectInput()</a></code> because it makes both states explicit, and it would be easy to add new states in the future:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="basic-case-study.html#cb79-1" tabindex="-1"></a>  <span class="fu">fluidRow</span>(</span>
<span id="cb79-2"><a href="basic-case-study.html#cb79-2" tabindex="-1"></a>    <span class="fu">column</span>(<span class="dv">8</span>,</span>
<span id="cb79-3"><a href="basic-case-study.html#cb79-3" tabindex="-1"></a>      <span class="fu">selectInput</span>(<span class="st">"code"</span>, <span class="st">"Product"</span>,</span>
<span id="cb79-4"><a href="basic-case-study.html#cb79-4" tabindex="-1"></a>        <span class="at">choices =</span> <span class="fu">setNames</span>(products<span class="sc">$</span>prod_code, products<span class="sc">$</span>title),</span>
<span id="cb79-5"><a href="basic-case-study.html#cb79-5" tabindex="-1"></a>        <span class="at">width =</span> <span class="st">"100%"</span></span>
<span id="cb79-6"><a href="basic-case-study.html#cb79-6" tabindex="-1"></a>      )</span>
<span id="cb79-7"><a href="basic-case-study.html#cb79-7" tabindex="-1"></a>    ),</span>
<span id="cb79-8"><a href="basic-case-study.html#cb79-8" tabindex="-1"></a>    <span class="fu">column</span>(<span class="dv">2</span>, <span class="fu">selectInput</span>(<span class="st">"y"</span>, <span class="st">"Y axis"</span>, <span class="fu">c</span>(<span class="st">"rate"</span>, <span class="st">"count"</span>)))</span>
<span id="cb79-9"><a href="basic-case-study.html#cb79-9" tabindex="-1"></a>  ),</span></code></pre></div>
<p>(I default to <code>rate</code> because I think it’s safer; you don’t need to understand the population distribution in order to correctly interpret the plot.)</p>
<p>Then I condition on that input when generating the plot:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">output</span><span class="op">$</span><span class="va">age_sex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">y</span> <span class="op">==</span> <span class="st">"count"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">n</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Estimated number of injuries"</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">rate</span>, colour <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Injuries per 10,000 people"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span></code></pre></div>
<p>A screenshot of the resulting app is shown in Figure <a href="basic-case-study.html#fig:rate-vs-count">4.5</a>.
You can find the source code at <a href="https://github.com/hadley/mastering-shiny/tree/main/neiss/rate-vs-count.R" class="uri">https://github.com/hadley/mastering-shiny/tree/main/neiss/rate-vs-count.R</a> and try out a live version of the app at <a href="https://hadley.shinyapps.io/ms-rate-vs-count" class="uri">https://hadley.shinyapps.io/ms-rate-vs-count</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:rate-vs-count"></span>
<img src="demos/basic-case-study/rate-vs-count.png" alt="In this iteration, we give the user the ability to switch between displaying the count or the population standardised rate on the y-axis." width="100%"><p class="caption">
Figure 4.5: In this iteration, we give the user the ability to switch between displaying the count or the population standardised rate on the y-axis.
</p>
</div>
</div>
<div id="narrative" class="section level2" number="4.7">
<h2>
<span class="header-section-number">4.7</span> Narrative<a class="anchor" aria-label="anchor" href="#narrative"><i class="fas fa-link"></i></a>
</h2>
<p>Finally, I want to provide some way to access the narratives because they are so interesting, and they give an informal way to cross-check the hypotheses you come up with when looking at the plots.
In the R code, I sample multiple narratives at once, but there’s no reason to do that in an app where you can explore interactively.</p>
<p>There are two parts to the solution.
First we add a new row to the bottom of the UI.
I use an action button to trigger a new story, and put the narrative in a <code><a href="https://rdrr.io/pkg/shiny/man/textOutput.html">textOutput()</a></code>:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"story"</span>, <span class="st">"Tell me a story"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textOutput.html">textOutput</a></span><span class="op">(</span><span class="st">"narrative"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>I then use <code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">eventReactive()</a></code> to create a reactive that only updates when the button is clicked or the underlying data changes.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">narrative_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">eventReactive</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">story</span>, <span class="fu">selected</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu">selected</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">narrative</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">narrative</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="fu">narrative_sample</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>A screenshot of the resulting app is shown in Figure <a href="basic-case-study.html#fig:narrative">4.6</a>.
You can find the source code at <a href="https://github.com/hadley/mastering-shiny/tree/main/neiss/narrative.R" class="uri">https://github.com/hadley/mastering-shiny/tree/main/neiss/narrative.R</a> and try out a live version of the app at <a href="https://hadley.shinyapps.io/ms-narrative" class="uri">https://hadley.shinyapps.io/ms-narrative</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:narrative"></span>
<img src="demos/basic-case-study/narrative.png" alt="The final iteration adds the ability to pull out a random narrative from the selected rows" width="100%"><p class="caption">
Figure 4.6: The final iteration adds the ability to pull out a random narrative from the selected rows
</p>
</div>
</div>
<div id="exercises-4" class="section level2" number="4.8">
<h2>
<span class="header-section-number">4.8</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-4"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>Draw the reactive graph for each app.</p></li>
<li><p>What happens if you flip <code><a href="https://forcats.tidyverse.org/reference/fct_inorder.html">fct_infreq()</a></code> and <code><a href="https://forcats.tidyverse.org/reference/fct_lump.html">fct_lump()</a></code> in the code that reduces the summary tables?</p></li>
<li><p>Add an input control that lets the user decide how many rows to show in the summary tables.</p></li>
<li>
<p>Provide a way to step through every narrative systematically with forward and backward buttons.</p>
<p>Advanced: Make the list of narratives “circular” so that advancing forward from the last narrative takes you to the first.</p>
</li>
</ol>
</div>
<div id="summary-3" class="section level2" number="4.9">
<h2>
<span class="header-section-number">4.9</span> Summary<a class="anchor" aria-label="anchor" href="#summary-3"><i class="fas fa-link"></i></a>
</h2>
<p>Now that you have the basics of Shiny apps under your belt, the following seven chapters will give you a grab bag of important techniques.
Once you’ve read the next chapter on workflow, I recommend skimming the remaining chapters so you get a good sense of what they cover, then dip your toes back in as you need the techniques for an app.</p>

</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="basic-reactivity.html"><span class="header-section-number">3</span> Basic reactivity</a></div>
<div class="next"><a href="action-intro.html">Introduction</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#basic-case-study"><span class="header-section-number">4</span> Case study: ER injuries</a></li>
<li><a class="nav-link" href="#introduction-3"><span class="header-section-number">4.1</span> Introduction</a></li>
<li><a class="nav-link" href="#the-data"><span class="header-section-number">4.2</span> The data</a></li>
<li><a class="nav-link" href="#exploration"><span class="header-section-number">4.3</span> Exploration</a></li>
<li><a class="nav-link" href="#prototype"><span class="header-section-number">4.4</span> Prototype</a></li>
<li><a class="nav-link" href="#polish-tables"><span class="header-section-number">4.5</span> Polish tables</a></li>
<li><a class="nav-link" href="#rate-vs-count"><span class="header-section-number">4.6</span> Rate vs count</a></li>
<li><a class="nav-link" href="#narrative"><span class="header-section-number">4.7</span> Narrative</a></li>
<li><a class="nav-link" href="#exercises-4"><span class="header-section-number">4.8</span> Exercises</a></li>
<li><a class="nav-link" href="#summary-3"><span class="header-section-number">4.9</span> Summary</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/mastering-shiny/blob/master/basic-case-study.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/mastering-shiny/edit/master/basic-case-study.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Mastering Shiny</strong>" was written by Hadley Wickham. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
