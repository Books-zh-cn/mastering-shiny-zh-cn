<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 Basic reactivity | Mastering Shiny</title>
<meta name="author" content="Hadley Wickham">
<meta name="generator" content="bookdown 0.34.2 with bs4_book()">
<meta property="og:title" content="Chapter 3 Basic reactivity | Mastering Shiny">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 3 Basic reactivity | Mastering Shiny">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.0/transition.js"></script><script src="libs/bs3compat-0.5.0/tabs.js"></script><script src="libs/bs3compat-0.5.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141197094-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-141197094-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<meta name="description" content="3.1 Introduction In Shiny, you express your server logic using reactive programming. Reactive programming is an elegant and powerful programming paradigm, but it can be disorienting at first...">
<meta property="og:description" content="3.1 Introduction In Shiny, you express your server logic using reactive programming. Reactive programming is an elegant and powerful programming paradigm, but it can be disorienting at first...">
<meta name="twitter:description" content="3.1 Introduction In Shiny, you express your server logic using reactive programming. Reactive programming is an elegant and powerful programming paradigm, but it can be disorienting at first...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Mastering Shiny</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Getting started</li>
<li><a class="" href="basic-intro.html">Introduction</a></li>
<li><a class="" href="basic-app.html"><span class="header-section-number">1</span> Your first Shiny app</a></li>
<li><a class="" href="basic-ui.html"><span class="header-section-number">2</span> Basic UI</a></li>
<li><a class="active" href="basic-reactivity.html"><span class="header-section-number">3</span> Basic reactivity</a></li>
<li><a class="" href="basic-case-study.html"><span class="header-section-number">4</span> Case study: ER injuries</a></li>
<li class="book-part">Shiny in action</li>
<li><a class="" href="action-intro.html">Introduction</a></li>
<li><a class="" href="action-workflow.html"><span class="header-section-number">5</span> Workflow</a></li>
<li><a class="" href="action-layout.html"><span class="header-section-number">6</span> Layout, themes, HTML</a></li>
<li><a class="" href="action-graphics.html"><span class="header-section-number">7</span> Graphics</a></li>
<li><a class="" href="action-feedback.html"><span class="header-section-number">8</span> User feedback</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/mastering-shiny">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="basic-reactivity" class="section level1" number="3">
<h1>
<span class="header-section-number">3</span> Basic reactivity<a class="anchor" aria-label="anchor" href="#basic-reactivity"><i class="fas fa-link"></i></a>
</h1>
<div id="introduction-2" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Introduction<a class="anchor" aria-label="anchor" href="#introduction-2"><i class="fas fa-link"></i></a>
</h2>
<p>In Shiny, you express your server logic using reactive programming.
Reactive programming is an elegant and powerful programming paradigm, but it can be disorienting at first because it’s a very different paradigm to writing a script.
The key idea of reactive programming is to specify a graph of dependencies so that when an input changes, all related outputs are automatically updated.
This makes the flow of an app considerably simpler, but it takes a while to get your head around how it all fits together.</p>
<p>This chapter will provide a gentle introduction to reactive programming, teaching you the basics of the most common reactive constructs you’ll use in Shiny apps.
We’ll start with a survey of the server function, discussing in more detail how the <code>input</code> and <code>output</code> arguments work.
Next we’ll review the simplest form of reactivity (where inputs are directly connected to outputs), and then discuss how reactive expressions allow you to eliminate duplicated work.
We’ll finish by reviewing some common roadblocks encountered by newer Shiny users.</p>
</div>
<div id="the-server-function" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> The server function<a class="anchor" aria-label="anchor" href="#the-server-function"><i class="fas fa-link"></i></a>
</h2>
<p>As you’ve seen, the guts of every Shiny app look like this:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.rstudio.com/">shiny</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="co"># front end interface</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># back end logic</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></span></code></pre></div>
<p>The previous chapter covered the basics of the front end, the <code>ui</code> object that contains the HTML presented to every user of your app.
The <code>ui</code> is simple because every user gets the same HTML.
The <code>server</code> is more complicated because every user needs to get an independent version of the app; when user A moves a slider, user B shouldn’t see their outputs change.</p>
<p>To achieve this independence, Shiny invokes your <code>server()</code> function each time a new session<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Each connection to a Shiny app starts a new session whether it’s connections from different people, or with multiple tabs from the same person.&lt;/p&gt;"><sup>5</sup></a> starts.
Just like any other R function, when the server function is called it creates a new local environment that is independent of every other invocation of the function.
This allows each session to have a unique state, as well as isolating the variables created <em>inside</em> the function.
This is why almost all of the reactive programming you’ll do in Shiny will be inside the server function<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;The primary exception is where there’s some work that can be shared across multiple users.
For example, all users might be looking at the same large csv file, so you might as well load it once and share it between users.
We’ll come back to that idea in Section &lt;a href="#schedule-data-munging"&gt;&lt;strong&gt;??&lt;/strong&gt;&lt;/a&gt;.&lt;/p&gt;'><sup>6</sup></a>
.</p>
<p>Server functions take three parameters: <code>input</code>, <code>output</code>, and <code>session</code>.
Because you never call the server function yourself, you’ll never create these objects yourself.
Instead, they’re created by Shiny when the session begins, connecting back to a specific session.
For the moment, we’ll focus on the <code>input</code> and <code>output</code> arguments, and leave <code>session</code> for later chapters.</p>
<div id="input" class="section level3" number="3.2.1">
<h3>
<span class="header-section-number">3.2.1</span> Input<a class="anchor" aria-label="anchor" href="#input"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>input</code> argument is a list-like object that contains all the input data sent from the browser, named according to the input ID.
For example, if your UI contains a numeric input control with an input ID of <code>count</code>, like so:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"count"</span>, label <span class="op">=</span> <span class="st">"Number of values"</span>, value <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>then you can access the value of that input with <code>input$count</code>.
It will initially contain the value <code>100</code>, and it will be automatically updated as the user changes the value in the browser.</p>
<p>Unlike a typical list, <code>input</code> objects are read-only.
If you attempt to modify an input inside the server function, you’ll get an error:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">input</span><span class="op">$</span><span class="va">count</span> <span class="op">&lt;-</span> <span class="fl">10</span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Can't modify read-only reactive value 'count'</span></span></code></pre></div>
<p>This error occurs because <code>input</code> reflects what’s happening in the browser, and the browser is Shiny’s “single source of truth”.
If you could modify the value in R, you could introduce inconsistencies, where the input slider said one thing in the browser, and <code>input$count</code> said something different in R.
That would make programming challenging!
Later, in Chapter <a href="action-feedback.html#action-feedback">8</a>, you’ll learn how to use functions like <code><a href="https://rdrr.io/pkg/shiny/man/updateNumericInput.html">updateNumericInput()</a></code> to modify the value in the browser, and then <code>input$count</code> will update accordingly.</p>
<p>One more important thing about <code>input</code>: it’s selective about who is allowed to read it.
To read from an <code>input</code>, you must be in a <strong>reactive context</strong> created by a function like <code><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText()</a></code> or <code><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive()</a></code>.
We’ll come back to that idea very shortly, but it’s an important constraint that allows outputs to automatically update when an input changes.
This code illustrates the error you’ll see if you make this mistake:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"The value of input$count is "</span>, <span class="va">input</span><span class="op">$</span><span class="va">count</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Can't access reactive value 'count' outside of reactive consumer.</span></span>
<span><span class="co">#&gt; ℹ Do you need to wrap inside reactive() or observer()?</span></span></code></pre></div>
</div>
<div id="output" class="section level3" number="3.2.2">
<h3>
<span class="header-section-number">3.2.2</span> Output<a class="anchor" aria-label="anchor" href="#output"><i class="fas fa-link"></i></a>
</h3>
<p><code>output</code> is very similar to <code>input</code>: it’s also a list-like object named according to the output ID.
The main difference is that you use it for sending output instead of receiving input.
You always use the <code>output</code> object in concert with a <code>render</code> function, as in the following simple example:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textOutput.html">textOutput</a></span><span class="op">(</span><span class="st">"greeting"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="st">"Hello human!"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>(Note that the ID is quoted in the UI, but not in the server.)</p>
<p>The render function does two things:</p>
<ul>
<li><p>It sets up a special reactive context that automatically tracks what inputs the output uses.</p></li>
<li><p>It converts the output of your R code into HTML suitable for display on a web page.</p></li>
</ul>
<p>Like the <code>input</code>, the <code>output</code> is picky about how you use it.
You’ll get an error if:</p>
<ul>
<li>
<p>You forget the <code>render</code> function.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="st">"Hello human"</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Unexpected character object for output$greeting</span></span>
<span><span class="co">#&gt; ℹ Did you forget to use a render function?</span></span></code></pre></div>
</li>
<li>
<p>You attempt to read from an output.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"The greeting is "</span>, <span class="va">output</span><span class="op">$</span><span class="va">greeting</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Reading from shinyoutput object is not allowed.</span></span></code></pre></div>
</li>
</ul>
</div>
</div>
<div id="reactive-programming" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Reactive programming<a class="anchor" aria-label="anchor" href="#reactive-programming"><i class="fas fa-link"></i></a>
</h2>
<p>An app is going to be pretty boring if it only has inputs or only has outputs.
The real magic of Shiny happens when you have an app with both.
Let’s look at a simple example:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textInput.html">textInput</a></span><span class="op">(</span><span class="st">"name"</span>, <span class="st">"What's your name?"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textOutput.html">textOutput</a></span><span class="op">(</span><span class="st">"greeting"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello "</span>, <span class="va">input</span><span class="op">$</span><span class="va">name</span>, <span class="st">"!"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>It’s hard to show how this works in a book, but I do my best in Figure <a href="basic-reactivity.html#fig:connection">3.1</a>.
If you run the app, and type in the name box, you’ll see that the greeting updates automatically as you type<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;If you’re running the live app, notice that you have to type fairly slowly for the output to update one letter at a time.
That’s because Shiny uses a technique called &lt;strong&gt;debouncing&lt;/strong&gt;, which means that it waits for a few ms before sending an update.
That considerably reduces the amount of work that Shiny needs to do, without appreciably reducing the response time of the app.&lt;/p&gt;"><sup>7</sup></a>.</p>
<div class="figure">
<span style="display:block;" id="fig:connection"></span>
<img src="demos/basic-reactivity/connection-1.png" alt="Reactivity means that outputs automatically update as inputs change, as in this app where I type 'J', 'o', 'e'. See live at &lt;https://hadley.shinyapps.io/ms-connection&gt;." width="25%"><img src="demos/basic-reactivity/connection-2.png" alt="Reactivity means that outputs automatically update as inputs change, as in this app where I type 'J', 'o', 'e'. See live at &lt;https://hadley.shinyapps.io/ms-connection&gt;." width="25%"><img src="demos/basic-reactivity/connection-3.png" alt="Reactivity means that outputs automatically update as inputs change, as in this app where I type 'J', 'o', 'e'. See live at &lt;https://hadley.shinyapps.io/ms-connection&gt;." width="25%"><p class="caption">
Figure 3.1: Reactivity means that outputs automatically update as inputs change, as in this app where I type ‘J’, ‘o’, ‘e’. See live at <a href="https://hadley.shinyapps.io/ms-connection" class="uri">https://hadley.shinyapps.io/ms-connection</a>.
</p>
</div>
<p>This is the big idea in Shiny: you don’t need to tell an output when to update, because Shiny automatically figures it out for you.
How does it work?
What exactly is going on in the body of the function?
Let’s think about the code inside the server function more precisely:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span><span class="op">$</span><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello "</span>, <span class="va">input</span><span class="op">$</span><span class="va">name</span>, <span class="st">"!"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>It’s easy to read this as “paste together ‘hello’ and the user’s name, then send it to <code>output$greeting</code>”.
But this mental model is wrong in a subtle, but important, way.
Think about it: with this model, you only issue the instruction once.
But Shiny performs the action every time we update <code>input$name</code>, so there must be something more going on.</p>
<p>The app works because the code doesn’t <em>tell</em> Shiny to create the string and send it to the browser, but instead, it informs Shiny <em>how it could</em> create the string if it needs to.
It’s up to Shiny when (and even if!) the code should be run.
It might be run as soon as the app launches, it might be quite a bit later; it might be run many times, or it might never be run!
This isn’t to imply that Shiny is capricious, only that it’s Shiny’s responsibility to decide when code is executed, not yours.
Think of your app as providing Shiny with recipes, not giving it commands.</p>
<div id="imperative-vs-declarative-programming" class="section level3" number="3.3.1">
<h3>
<span class="header-section-number">3.3.1</span> Imperative vs declarative programming<a class="anchor" aria-label="anchor" href="#imperative-vs-declarative-programming"><i class="fas fa-link"></i></a>
</h3>
<p>This difference between commands and recipes is one of the key differences between two important styles of programming:</p>
<ul>
<li><p>In <strong>imperative</strong> programming, you issue a specific command and it’s carried out immediately.
This is the style of programming you’re used to in your analysis scripts: you command R to load your data, transform it, visualise it, and save the results to disk.</p></li>
<li><p>In <strong>declarative</strong> programming, you express higher-level goals or describe important constraints, and rely on someone else to decide how and/or when to translate that into action.
This is the style of programming you use in Shiny.</p></li>
</ul>
<p>With imperative code you say “Make me a sandwich”<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;a href="https://xkcd.com/149/" class="uri"&gt;https://xkcd.com/149/&lt;/a&gt;&lt;/p&gt;'><sup>8</sup></a>.
With declarative code you say “Ensure there is a sandwich in the refrigerator whenever I look inside of it”.
Imperative code is assertive; declarative code is passive-aggressive.</p>
<p>Most of the time, declarative programming is tremendously freeing: you describe your overall goals, and the software figures out how to achieve them without further intervention.
The downside is the occasional time where you know exactly what you want, but you can’t figure out how to frame it in a way that the declarative system understands<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;If you’ve ever struggled to get a ggplot2 legend to look exactly the way you want, you’ve encountered this problem!&lt;/p&gt;"><sup>9</sup></a>.
The goal of this book is to help you develop your understanding of the underlying theory so that happens as infrequently as possible.</p>
</div>
<div id="laziness" class="section level3" number="3.3.2">
<h3>
<span class="header-section-number">3.3.2</span> Laziness<a class="anchor" aria-label="anchor" href="#laziness"><i class="fas fa-link"></i></a>
</h3>
<p>One of the strengths of declarative programming in Shiny is that it allows apps to be extremely lazy.
A Shiny app will only ever do the minimal amount of work needed to update the output controls that you can currently see<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Yes, Shiny doesn’t update the output if you can’t see it in your browser!
Shiny is so lazy that it doesn’t do the work unless you can actually see the results.&lt;/p&gt;"><sup>10</sup></a>.
This laziness, however, comes with an important downside that you should be aware of.
Can you spot what’s wrong with the server function below?</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">greting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello "</span>, <span class="va">input</span><span class="op">$</span><span class="va">name</span>, <span class="st">"!"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If you look closely, you might notice that I’ve written <code>greting</code> instead of <code>greeting</code>.
This won’t generate an error in Shiny, but it won’t do what you want.
The <code>greting</code> output doesn’t exist, so the code inside <code><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText()</a></code> will never be run.</p>
<p>If you’re working on a Shiny app and you just can’t figure out why your code never gets run, double check that your UI and server functions are using the same identifiers.</p>
</div>
<div id="the-reactive-graph" class="section level3" number="3.3.3">
<h3>
<span class="header-section-number">3.3.3</span> The reactive graph<a class="anchor" aria-label="anchor" href="#the-reactive-graph"><i class="fas fa-link"></i></a>
</h3>
<p>Shiny’s laziness has another important property.
In most R code, you can understand the order of execution by reading the code from top to bottom.
That doesn’t work in Shiny, because code is only run when needed.
To understand the order of execution you need to instead look at the <strong>reactive graph</strong>, which describes how inputs and outputs are connected.
The reactive graph for the app above is very simple and shown in Figure <a href="basic-reactivity.html#fig:graph-simple">3.2</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:graph-simple"></span>
<img src="diagrams/basic-reactivity/graph-1b.png" alt="The reactive graph shows how the inputs and outputs are connected" width="181"><p class="caption">
Figure 3.2: The reactive graph shows how the inputs and outputs are connected
</p>
</div>
<p>The reactive graph contains one symbol for every input and output, and we connect an input to an output whenever the output accesses the input.
This graph tells you that <code>greeting</code> will need to be recomputed whenever <code>name</code> is changed.
We’ll often describe this relationship as <code>greeting</code> has a <strong>reactive dependency</strong> on <code>name</code>.</p>
<p>Note the graphical conventions we used for the inputs and outputs: the <code>name</code> input naturally fits into the <code>greeting</code> output.
We could draw them closely packed together, as in Figure <a href="basic-reactivity.html#fig:graph-collapsed">3.3</a>, to emphasise the way that they fit together; we won’t normally do that because it only works for the simplest of apps.</p>
<div class="figure">
<span style="display:block;" id="fig:graph-collapsed"></span>
<img src="diagrams/basic-reactivity/graph-1a.png" alt="The shapes used by the components of the reactive graph evoke the ways in which they connect." width="143"><p class="caption">
Figure 3.3: The shapes used by the components of the reactive graph evoke the ways in which they connect.
</p>
</div>
<p>The reactive graph is a powerful tool for understanding how your app works.
As your app gets more complicated, it’s often useful to make a quick high-level sketch of the reactive graph to remind you how all the pieces fit together.
Throughout this book we’ll show you the reactive graph to help understand how the examples work, and later on, in Chapter 14, you’ll learn how to use reactlog which will draw the graph for you.</p>
</div>
<div id="reactive-expressions" class="section level3" number="3.3.4">
<h3>
<span class="header-section-number">3.3.4</span> Reactive expressions<a class="anchor" aria-label="anchor" href="#reactive-expressions"><i class="fas fa-link"></i></a>
</h3>
<p>There’s one more important component that you’ll see in the reactive graph: the reactive expression.
We’ll come back to reactive expressions in detail very shortly; for now think of them as a tool that reduces duplication in your reactive code by introducing additional nodes into the reactive graph.</p>
<p>We don’t need a reactive expression in our very simple app, but I’ll add one anyway so you can see how it affects the reactive graph, Figure <a href="basic-reactivity.html#fig:graph-expression">3.4</a>.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">string</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello "</span>, <span class="va">input</span><span class="op">$</span><span class="va">name</span>, <span class="st">"!"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="fu">string</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:graph-expression"></span>
<img src="diagrams/basic-reactivity/graph-2b.png" alt="A reactive expression is drawn with angles on both sides because it connects inputs to outputs." width="291"><p class="caption">
Figure 3.4: A reactive expression is drawn with angles on both sides because it connects inputs to outputs.
</p>
</div>
<p>Reactive expressions take inputs and produce outputs so they have a shape that combines features of both inputs and outputs.
Hopefully, the shapes will help you remember how the components fit together.</p>
</div>
<div id="execution-order" class="section level3" number="3.3.5">
<h3>
<span class="header-section-number">3.3.5</span> Execution order<a class="anchor" aria-label="anchor" href="#execution-order"><i class="fas fa-link"></i></a>
</h3>
<p>It’s important to understand that the order your code run is solely determined by the reactive graph.
This is different from most R code where the execution order is determined by the order of lines.
For example, we could flip the order of the two lines in our simple server function:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="fu">string</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">string</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello "</span>, <span class="va">input</span><span class="op">$</span><span class="va">name</span>, <span class="st">"!"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>You might think that this would yield an error because <code>output$greeting</code> refers to a reactive expression, <code>string</code>, that hasn’t been created yet.
But remember Shiny is lazy, so that code is only run when the session starts, after <code>string</code> has been created.</p>
<p>Instead, this code yields the same reactive graph as above, so the order in which the code is run is exactly the same.
Organising your code like this is confusing for humans, and best avoided.
Instead, make sure that reactive expressions and outputs only refer to things defined above, not below<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;The technical term for this ordering is a “topological sort”.&lt;/p&gt;"><sup>11</sup></a>.
This will make your code easier to understand.</p>
<p>This concept is very important and different to most other R code, so I’ll say it again: the order in which reactive code is run is determined only by the reactive graph, not by its layout in the server function.</p>
</div>
<div id="exercises-3" class="section level3" number="3.3.6">
<h3>
<span class="header-section-number">3.3.6</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises-3"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Given this UI:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textInput.html">textInput</a></span><span class="op">(</span><span class="st">"name"</span>, <span class="st">"What's your name?"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textOutput.html">textOutput</a></span><span class="op">(</span><span class="st">"greeting"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Fix the simple errors found in each of the three server functions below.
First try spotting the problem just by reading the code; then run the code to make sure you’ve fixed it.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">server</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">input</span><span class="op">$</span><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello "</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">server2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">server</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">greeting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello "</span>, <span class="va">input</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="va">greeting</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">server3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">server</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">greting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello"</span>, <span class="va">input</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p>Draw the reactive graph for the following server functions:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">a</span> <span class="op">+</span> <span class="va">input</span><span class="op">$</span><span class="va">b</span><span class="op">)</span></span>
<span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">input</span><span class="op">$</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="fu">e</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">server2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">x1</span> <span class="op">+</span> <span class="va">input</span><span class="op">$</span><span class="va">x2</span> <span class="op">+</span> <span class="va">input</span><span class="op">$</span><span class="va">x3</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">y1</span> <span class="op">+</span> <span class="va">input</span><span class="op">$</span><span class="va">y2</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="fu">x</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fu">y</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">server3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">^</span> <span class="va">input</span><span class="op">$</span><span class="va">d</span><span class="op">)</span></span>
<span>  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">a</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu">b</span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">input</span><span class="op">$</span><span class="va">c</span><span class="op">)</span> </span>
<span>  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rstudio.github.io/htmltools/reference/builder.html">a</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">input</span><span class="op">$</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</li>
<li>
<p>Why will this code fail?</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">input</span><span class="op">$</span><span class="va">var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Why are <code><a href="https://rdrr.io/r/base/range.html">range()</a></code> and <code><a href="https://rdrr.io/r/stats/cor.html">var()</a></code> bad names for reactive?</p>
</li>
</ol>
</div>
</div>
<div id="reactive-expressions-1" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Reactive expressions<a class="anchor" aria-label="anchor" href="#reactive-expressions-1"><i class="fas fa-link"></i></a>
</h2>
<p>We’ve quickly skimmed over reactive expressions a couple of times, so you’re hopefully getting a sense for what they might do.
Now we’ll dive into more of the details, and show why they are so important when constructing real apps.</p>
<p>Reactive expressions are important because they give <em>Shiny</em> more information so that it can do less recomputation when inputs change, making apps more efficient, and they make it easier for <em>humans</em> to understand the app by simplifying the reactive graph.
Reactive expressions have a flavour of both inputs and outputs:</p>
<ul>
<li><p>Like inputs, you can use the results of a reactive expression in an output.</p></li>
<li><p>Like outputs, reactive expressions depend on inputs and automatically know when they need updating.</p></li>
</ul>
<p>This duality means we need some new vocab: I’ll use <strong>producers</strong> to refer to reactive inputs and expressions, and <strong>consumers</strong> to refer to reactive expressions and outputs.
Figure <a href="basic-reactivity.html#fig:prod-consumer">3.5</a> shows this relationship with a Venn diagram.</p>
<div class="figure">
<span style="display:block;" id="fig:prod-consumer"></span>
<img src="diagrams/basic-reactivity/producers-consumers.png" alt="Inputs and expressions are reactive producers; expressions and outputs are reactive consumers" width="332"><p class="caption">
Figure 3.5: Inputs and expressions are reactive producers; expressions and outputs are reactive consumers
</p>
</div>
<p>We’re going to need a more complex app to see the benefits of using reactive expressions.
First, we’ll set the stage by defining some regular R functions that we’ll use to power our app.</p>
<div id="the-motivation" class="section level3" number="3.4.1">
<h3>
<span class="header-section-number">3.4.1</span> The motivation<a class="anchor" aria-label="anchor" href="#the-motivation"><i class="fas fa-link"></i></a>
</h3>
<p>Imagine I want to compare two simulated datasets with a plot and a hypothesis test.
I’ve done a little experimentation and come up with the functions below: <code>freqpoly()</code> visualises the two distributions with frequency polygons<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;If you haven’t heard of a frequency polygon before, it’s just a histogram that’s drawn with a line, instead of bars, which makes it easier to compare multiple data sets on the same plot.&lt;/p&gt;"><sup>12</sup></a>, and <code>t_test()</code> uses a t-test to compare means and summarises the results with a string:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'ggplot2' was built under R version 4.2.3</span></span>
<span></span>
<span><span class="va">freqpoly</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, <span class="va">binwidth</span> <span class="op">=</span> <span class="fl">0.1</span>, <span class="va">xlim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span>,</span>
<span>    g <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"x2"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, colour <span class="op">=</span> <span class="va">g</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_freqpoly</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="va">binwidth</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">xlim</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">t_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># use sprintf() to format t.test() results compactly</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span></span>
<span>    <span class="st">"p value: %0.3f\n[%0.2f, %0.2f]"</span>,</span>
<span>    <span class="va">test</span><span class="op">$</span><span class="va">p.value</span>, <span class="va">test</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">test</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If I have some simulated data, I can use these functions to compare two variables:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">200</span>, mean <span class="op">=</span> <span class="fl">0.15</span>, sd <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">freqpoly</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; ℹ Please use `linewidth` instead.</span></span>
<span><span class="co">#&gt; This warning is displayed once every 8 hours.</span></span>
<span><span class="co">#&gt; Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span>
<span><span class="co">#&gt; generated.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu">t_test</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; p value: 0.430</span></span>
<span><span class="co">#&gt; [-0.22, 0.09]</span></span></code></pre></div>
<div class="inline-figure"><img src="basic-reactivity_files/figure-html/unnamed-chunk-19-1.png" width="70%"></div>
<p>In a real analysis, you probably would’ve done a bunch of exploration before you ended up with these functions.
I’ve skipped that exploration here so we can get to the app as quickly as possible.
But extracting imperative code out into regular functions is an important technique for all Shiny apps: the more code you can extract out of your app, the easier it will be to understand.
This is good software engineering because it helps isolate concerns: the functions outside of the app focus on the computation so that the code inside of the app can focus on responding to user actions.
We’ll come back to that idea again in Chapter <a href="#scaling-functions"><strong>??</strong></a>.</p>
</div>
<div id="the-app" class="section level3" number="3.4.2">
<h3>
<span class="header-section-number">3.4.2</span> The app<a class="anchor" aria-label="anchor" href="#the-app"><i class="fas fa-link"></i></a>
</h3>
<p>I’d like to use these two tools to quickly explore a bunch of simulations.
A Shiny app is a great way to do this because it lets you avoid tediously modifying and re-running R code.
Below I wrap the pieces into a Shiny app where I can interactively tweak the inputs.</p>
<p>Let’s start with the UI.
We’ll come back to exactly what <code><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow()</a></code> and <code><a href="https://rdrr.io/pkg/shiny/man/column.html">column()</a></code> do in Section <a href="action-layout.html#multi-row">6.2.3</a>; but you can guess their purpose from their names 😄.
The first row has three columns for input controls (distribution 1, distribution 2, and plot controls).
The second row has a wide column for the plot, and a narrow column for the hypothesis test.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">4</span>, </span>
<span>      <span class="st">"Distribution 1"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"n1"</span>, label <span class="op">=</span> <span class="st">"n"</span>, value <span class="op">=</span> <span class="fl">1000</span>, min <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"mean1"</span>, label <span class="op">=</span> <span class="st">"µ"</span>, value <span class="op">=</span> <span class="fl">0</span>, step <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"sd1"</span>, label <span class="op">=</span> <span class="st">"σ"</span>, value <span class="op">=</span> <span class="fl">0.5</span>, min <span class="op">=</span> <span class="fl">0.1</span>, step <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">4</span>, </span>
<span>      <span class="st">"Distribution 2"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"n2"</span>, label <span class="op">=</span> <span class="st">"n"</span>, value <span class="op">=</span> <span class="fl">1000</span>, min <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"mean2"</span>, label <span class="op">=</span> <span class="st">"µ"</span>, value <span class="op">=</span> <span class="fl">0</span>, step <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"sd2"</span>, label <span class="op">=</span> <span class="st">"σ"</span>, value <span class="op">=</span> <span class="fl">0.5</span>, min <span class="op">=</span> <span class="fl">0.1</span>, step <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">4</span>,</span>
<span>      <span class="st">"Frequency polygon"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"binwidth"</span>, label <span class="op">=</span> <span class="st">"Bin width"</span>, value <span class="op">=</span> <span class="fl">0.1</span>, step <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/sliderInput.html">sliderInput</a></span><span class="op">(</span><span class="st">"range"</span>, label <span class="op">=</span> <span class="st">"range"</span>, value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="st">"hist"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textOutput.html">verbatimTextOutput</a></span><span class="op">(</span><span class="st">"ttest"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The server function combines calls to <code>freqpoly()</code> and <code>t_test()</code> functions after drawing from the specified distributions:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n1</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean1</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd1</span><span class="op">)</span></span>
<span>    <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n2</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean2</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd2</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">freqpoly</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, binwidth <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">binwidth</span>, xlim <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">range</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">ttest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n1</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean1</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd1</span><span class="op">)</span></span>
<span>    <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n2</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean2</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd2</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu">t_test</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:ttest"></span>
<img src="demos/basic-reactivity/case-study-1.png" alt="A Shiny app that lets you compare two simulated distributions with a t-test and a frequency polygon See live at &lt;https://hadley.shinyapps.io/ms-case-study-1&gt;." width="100%"><p class="caption">
Figure 3.6: A Shiny app that lets you compare two simulated distributions with a t-test and a frequency polygon See live at <a href="https://hadley.shinyapps.io/ms-case-study-1" class="uri">https://hadley.shinyapps.io/ms-case-study-1</a>.
</p>
</div>
<p>This definition of <code>server</code> and <code>ui</code> yields Figure <a href="basic-reactivity.html#fig:ttest">3.6</a>.
You can find a live version at <a href="https://hadley.shinyapps.io/ms-case-study-1" class="uri">https://hadley.shinyapps.io/ms-case-study-1</a>; I recommend opening the app and having a quick play to make sure you understand its basic operation before you continue reading.</p>
</div>
<div id="the-reactive-graph-1" class="section level3" number="3.4.3">
<h3>
<span class="header-section-number">3.4.3</span> The reactive graph<a class="anchor" aria-label="anchor" href="#the-reactive-graph-1"><i class="fas fa-link"></i></a>
</h3>
<p>Let’s start by drawing the reactive graph of this app.
Shiny is smart enough to update an output only when the inputs it refers to change; it’s not smart enough to only selectively run pieces of code inside an output.
In other words, outputs are atomic: they’re either executed or not as a whole.</p>
<p>For example, take this snippet from the server:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n1</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean1</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd1</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n2</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean2</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd2</span><span class="op">)</span></span>
<span><span class="fu">t_test</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span></code></pre></div>
<p>As a human reading this code you can tell that we only need to update <code>x1</code> when <code>n1</code>, <code>mean1</code>, or <code>sd1</code> changes, and we only need to update <code>x2</code> when <code>n2</code>, <code>mean2</code>, or <code>sd2</code> changes.
Shiny, however, only looks at the output as a whole, so it will update both <code>x1</code> and <code>x2</code> every time one of <code>n1</code>, <code>mean1</code>, <code>sd1</code>, <code>n2</code>, <code>mean2</code>, or <code>sd2</code> changes.
This leads to the reactive graph shown in Figure <a href="basic-reactivity.html#fig:ttest-react1">3.7</a>:</p>
<div class="figure">
<span style="display:block;" id="fig:ttest-react1"></span>
<img src="diagrams/basic-reactivity/case-study-1.png" alt="The reactive graph shows that every output depends on every input" width="207"><p class="caption">
Figure 3.7: The reactive graph shows that every output depends on every input
</p>
</div>
<p>You’ll notice that the graph is very dense: almost every input is connected directly to every output.
This creates two problems:</p>
<ul>
<li><p>The app is hard to understand because there are so many connections.
There are no pieces of the app that you can pull out and analyse in isolation.</p></li>
<li><p>The app is inefficient because it does more work than necessary.
For example, if you change the breaks of the plot, the data is recalculated; if you change the value of <code>n1</code>, <code>x2</code> is updated (in two places!).</p></li>
</ul>
<p>There’s one other major flaw in the app: the frequency polygon and t-test use separate random draws.
This is rather misleading, as you’d expect them to be working on the same underlying data.</p>
<p>Fortunately, we can fix all these problems by using reactive expressions to pull out repeated computation.</p>
</div>
<div id="simplifying-the-graph" class="section level3" number="3.4.4">
<h3>
<span class="header-section-number">3.4.4</span> Simplifying the graph<a class="anchor" aria-label="anchor" href="#simplifying-the-graph"><i class="fas fa-link"></i></a>
</h3>
<p>In the server function below we refactor the existing code to pull out the repeated code into two new reactive expressions, <code>x1</code> and <code>x2</code>, which simulate the data from the two distributions.
To create a reactive expression, we call <code><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive()</a></code> and assign the results to a variable.
To later use the expression, we call the variable like it’s a function.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n1</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean1</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n2</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean2</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">freqpoly</span><span class="op">(</span><span class="fu">x1</span><span class="op">(</span><span class="op">)</span>, <span class="fu">x2</span><span class="op">(</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">binwidth</span>, xlim <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">range</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">ttest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">t_test</span><span class="op">(</span><span class="fu">x1</span><span class="op">(</span><span class="op">)</span>, <span class="fu">x2</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This transformation yields the substantially simpler graph shown in Figure <a href="basic-reactivity.html#fig:ttest-react2">3.8</a>.
This simpler graph makes it easier to understand the app because you can understand connected components in isolation; the values of the distribution parameters only affect the output via <code>x1</code> and <code>x2</code>.
This rewrite also makes the app much more efficient since it does much less computation.
Now, when you change the <code>binwidth</code> or <code>range</code>, only the plot changes, not the underlying data.</p>
<div class="figure">
<span style="display:block;" id="fig:ttest-react2"></span>
<img src="diagrams/basic-reactivity/case-study-2.png" alt="Using reactive expressions considerably simplifies the graph, making it much easier to understand" width="252"><p class="caption">
Figure 3.8: Using reactive expressions considerably simplifies the graph, making it much easier to understand
</p>
</div>
<p>To emphasise this modularity Figure <a href="basic-reactivity.html#fig:ttest-module">3.9</a> draws boxes around the independent components.
We’ll come back to this idea in Chapter <a href="#scaling-modules"><strong>??</strong></a>, when we discuss modules.
Modules allow you to extract out repeated code for reuse, while guaranteeing that it’s isolated from everything else in the app.
Modules are an extremely useful and powerful technique for more complex apps.</p>
<div class="figure">
<span style="display:block;" id="fig:ttest-module"></span>
<img src="diagrams/basic-reactivity/case-study-3.png" alt="Modules enforce isolation between parts of an app" width="255"><p class="caption">
Figure 3.9: Modules enforce isolation between parts of an app
</p>
</div>
<p>You might be familiar with the “rule of three” of programming: whenever you copy and paste something three times, you should figure out how to reduce the duplication (typically by writing a function).
This is important because it reduces the amount of duplication in your code, which makes it easier to understand, and easier to update as your requirements change.</p>
<p>In Shiny, however, I think you should consider the rule of one: whenever you copy and paste something <em>once</em>, you should consider extracting the repeated code out into a reactive expression.
The rule is stricter for Shiny because reactive expressions don’t just make it easier for humans to understand the code, they also improve Shiny’s ability to efficiently rerun code.</p>
</div>
<div id="reactive-roadblocks" class="section level3" number="3.4.5">
<h3>
<span class="header-section-number">3.4.5</span> Why do we need reactive expressions?<a class="anchor" aria-label="anchor" href="#reactive-roadblocks"><i class="fas fa-link"></i></a>
</h3>
<p>When you first start working with reactive code, you might wonder why we need reactive expressions.
Why can’t you use your existing tools for reducing duplication in code: creating new variables and writing functions?
Unfortunately neither of these techniques work in a reactive environment.</p>
<p>If you try to use a variable to reduce duplication, you might write something like this:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n1</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean1</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd1</span><span class="op">)</span></span>
<span>  <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n2</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean2</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">freqpoly</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span>, binwidth <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">binwidth</span>, xlim <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">range</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">ttest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">t_test</span><span class="op">(</span><span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If you run this code, you’ll get an error because you’re attempting to access input values outside of a reactive context.
Even if you didn’t get that error, you’d still have a problem: <code>x1</code> and <code>x2</code> would only be computed once, when the session begins, not every time one of the inputs was updated.</p>
<p>If you try to use a function, the app will work:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n1</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean1</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd1</span><span class="op">)</span></span>
<span>  <span class="va">x2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n2</span>, <span class="va">input</span><span class="op">$</span><span class="va">mean2</span>, <span class="va">input</span><span class="op">$</span><span class="va">sd2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">freqpoly</span><span class="op">(</span><span class="fu">x1</span><span class="op">(</span><span class="op">)</span>, <span class="fu">x2</span><span class="op">(</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">binwidth</span>, xlim <span class="op">=</span> <span class="va">input</span><span class="op">$</span><span class="va">range</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">ttest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">t_test</span><span class="op">(</span><span class="fu">x1</span><span class="op">(</span><span class="op">)</span>, <span class="fu">x2</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>But it has the same problem as the original code: any input will cause all outputs to be recomputed, and the t-test and the frequency polygon will be run on separate samples.
Reactive expressions automatically cache their results, and only update when their inputs change<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;If you’re familiar with memoisation, this is a similar idea.&lt;/p&gt;"><sup>13</sup></a>.</p>
<p>While variables calculate the value only once (the porridge is too cold), and functions calculate the value every time they’re called (the porridge is too hot), reactive expressions calculate the value only when it might have changed (the porridge is just right!).</p>
</div>
</div>
<div id="controlling-timing-of-evaluation" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> Controlling timing of evaluation<a class="anchor" aria-label="anchor" href="#controlling-timing-of-evaluation"><i class="fas fa-link"></i></a>
</h2>
<p>Now that you’re familiar with the basic ideas of reactivity, we’ll discuss two more advanced techniques that allow you to either increase or decrease how often a reactive expression is executed.
Here I’ll show how to use the basic techniques; in Chapter <a href="#reactivity-objects"><strong>??</strong></a>, we’ll come back to their underlying implementations.</p>
<p>To explore the basic ideas, I’m going to simplify my simulation app.
I’ll use a distribution with only one parameter, and force both samples to share the same <code>n</code>.
I’ll also remove the plot controls.
This yields a smaller UI object and server function:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">3</span>, </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"lambda1"</span>, label <span class="op">=</span> <span class="st">"lambda1"</span>, value <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"lambda2"</span>, label <span class="op">=</span> <span class="st">"lambda2"</span>, value <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"n"</span>, label <span class="op">=</span> <span class="st">"n"</span>, value <span class="op">=</span> <span class="fl">1e4</span>, min <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="st">"hist"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span>, <span class="va">input</span><span class="op">$</span><span class="va">lambda1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span>, <span class="va">input</span><span class="op">$</span><span class="va">lambda2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">freqpoly</span><span class="op">(</span><span class="fu">x1</span><span class="op">(</span><span class="op">)</span>, <span class="fu">x2</span><span class="op">(</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This generates the app shown in Figure <a href="basic-reactivity.html#fig:sim">3.10</a> and reactive graph shown in Figure <a href="basic-reactivity.html#fig:sim-react">3.11</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:sim"></span>
<img src="demos/basic-reactivity/simulation-2.png" alt="A simpler app that displays a frequency polygon of random numbers drawn from two Poisson distributions. See live at &lt;https://hadley.shinyapps.io/ms-simulation-2&gt;." width="100%"><p class="caption">
Figure 3.10: A simpler app that displays a frequency polygon of random numbers drawn from two Poisson distributions. See live at <a href="https://hadley.shinyapps.io/ms-simulation-2" class="uri">https://hadley.shinyapps.io/ms-simulation-2</a>.
</p>
</div>
<div class="figure">
<span style="display:block;" id="fig:sim-react"></span>
<img src="diagrams/basic-reactivity/timing.png" alt="The reactive graph" width="314"><p class="caption">
Figure 3.11: The reactive graph
</p>
</div>
<div id="timed-invalidation" class="section level3" number="3.5.1">
<h3>
<span class="header-section-number">3.5.1</span> Timed invalidation<a class="anchor" aria-label="anchor" href="#timed-invalidation"><i class="fas fa-link"></i></a>
</h3>
<p>Imagine you wanted to reinforce the fact that this is for simulated data by constantly resimulating the data, so that you see an animation rather than a static plot<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;The New York Times used this technique particularly effectively in their article discussing how to interpret the jobs report: &lt;a href="https://www.nytimes.com/2014/05/02/upshot/how-not-to-be-misled-by-the-jobs-report.html" class="uri"&gt;https://www.nytimes.com/2014/05/02/upshot/how-not-to-be-misled-by-the-jobs-report.html&lt;/a&gt;&lt;/p&gt;'><sup>14</sup></a>.
We can increase the frequency of updates with a new function: <code><a href="https://rdrr.io/pkg/shiny/man/reactiveTimer.html">reactiveTimer()</a></code>.</p>
<p><code><a href="https://rdrr.io/pkg/shiny/man/reactiveTimer.html">reactiveTimer()</a></code> is a reactive expression that has a dependency on a hidden input: the current time.
You can use a <code><a href="https://rdrr.io/pkg/shiny/man/reactiveTimer.html">reactiveTimer()</a></code> when you want a reactive expression to invalidate itself more often than it otherwise would.
For example, the following code uses an interval of 500 ms so that the plot will update twice a second.
This is fast enough to remind you that you’re looking at a simulation, without dizzying you with rapid changes.
This change yields the reactive graph shown in Figure <a href="basic-reactivity.html#fig:sim-timer">3.12</a></p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">timer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactiveTimer.html">reactiveTimer</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">timer</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span>, <span class="va">input</span><span class="op">$</span><span class="va">lambda1</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">timer</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span>, <span class="va">input</span><span class="op">$</span><span class="va">lambda2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">freqpoly</span><span class="op">(</span><span class="fu">x1</span><span class="op">(</span><span class="op">)</span>, <span class="fu">x2</span><span class="op">(</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:sim-timer"></span>
<img src="diagrams/basic-reactivity/timing-timer.png" alt="`reactiveTimer(500)` introduces a new reactive input that automatically invalidates every half a second" width="416"><p class="caption">
Figure 3.12: <code>reactiveTimer(500)</code> introduces a new reactive input that automatically invalidates every half a second
</p>
</div>
<p>Note how we use <code>timer()</code> in the reactive expressions that compute <code>x1()</code> and <code>x2()</code>: we call it, but don’t use the value.
This lets <code>x1</code> and <code>x2</code> take a reactive dependency on <code>timer</code>, without worrying about exactly what value it returns.</p>
</div>
<div id="on-click" class="section level3" number="3.5.2">
<h3>
<span class="header-section-number">3.5.2</span> On click<a class="anchor" aria-label="anchor" href="#on-click"><i class="fas fa-link"></i></a>
</h3>
<p>In the above scenario, think about what would happen if the simulation code took 1 second to run.
We perform the simulation every 0.5s, so Shiny would have more and more to do, and would never be able to catch up.
The same problem can happen if someone is rapidly clicking buttons in your app and the computation you are doing is relatively expensive.
It’s possible to create a big backlog of work for Shiny, and while it’s working on the backlog, it can’t respond to any new events.
This leads to a poor user experience.</p>
<p>If this situation arises in your app, you might want to require the user to opt-in to performing the expensive calculation by requiring them to click a button.
This is a great use case for an <code><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton()</a></code>:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidRow</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">3</span>, </span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"lambda1"</span>, label <span class="op">=</span> <span class="st">"lambda1"</span>, value <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"lambda2"</span>, label <span class="op">=</span> <span class="st">"lambda2"</span>, value <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/numericInput.html">numericInput</a></span><span class="op">(</span><span class="st">"n"</span>, label <span class="op">=</span> <span class="st">"n"</span>, value <span class="op">=</span> <span class="fl">1e4</span>, min <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/actionButton.html">actionButton</a></span><span class="op">(</span><span class="st">"simulate"</span>, <span class="st">"Simulate!"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/column.html">column</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html">plotOutput</a></span><span class="op">(</span><span class="st">"hist"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>To use the action button we need to learn a new tool.
To see why, let’s first tackle the problem using the same approach as above.
As above, we refer to <code>simulate</code> without using its value to take a reactive dependency on it.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">input</span><span class="op">$</span><span class="va">simulate</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span>, <span class="va">input</span><span class="op">$</span><span class="va">lambda1</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">input</span><span class="op">$</span><span class="va">simulate</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span>, <span class="va">input</span><span class="op">$</span><span class="va">lambda2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">freqpoly</span><span class="op">(</span><span class="fu">x1</span><span class="op">(</span><span class="op">)</span>, <span class="fu">x2</span><span class="op">(</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:sim-button"></span>
<img src="demos/basic-reactivity/action-button.png" alt="App with action button. See live at &lt;https://hadley.shinyapps.io/ms-action-button&gt;." width="100%"><p class="caption">
Figure 3.13: App with action button. See live at <a href="https://hadley.shinyapps.io/ms-action-button" class="uri">https://hadley.shinyapps.io/ms-action-button</a>.
</p>
</div>
<div class="figure">
<span style="display:block;" id="fig:sim-button1-react"></span>
<img src="diagrams/basic-reactivity/timing-button.png" alt="This reactive graph doesn't accomplish our goal; we've added a dependency instead of replacing the existing dependencies." width="416"><p class="caption">
Figure 3.14: This reactive graph doesn’t accomplish our goal; we’ve added a dependency instead of replacing the existing dependencies.
</p>
</div>
<p>This yields the app in Figure <a href="basic-reactivity.html#fig:sim-button">3.13</a> and reactive graph in Figure <a href="basic-reactivity.html#fig:sim-button1-react">3.14</a>.
This doesn’t achieve our goal because it just introduces a new dependency: <code>x1()</code> and <code>x2()</code> will update when we click the simulate button, but they’ll also continue to update when <code>lambda1</code>, <code>lambda2</code>, or <code>n</code> change.
We want to <em>replace</em> the existing dependencies, not add to them.</p>
<p>To solve this problem we need a new tool: a way to use input values without taking a reactive dependency on them.
We need <code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">eventReactive()</a></code>, which has two arguments: the first argument specifies what to take a dependency on, and the second argument specifies what to compute.
That allows this app to only compute <code>x1()</code> and <code>x2()</code> when <code>simulate</code> is clicked:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">eventReactive</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">simulate</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span>, <span class="va">input</span><span class="op">$</span><span class="va">lambda1</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">eventReactive</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">simulate</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">n</span>, <span class="va">input</span><span class="op">$</span><span class="va">lambda2</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">hist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPlot.html">renderPlot</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="fu">freqpoly</span><span class="op">(</span><span class="fu">x1</span><span class="op">(</span><span class="op">)</span>, <span class="fu">x2</span><span class="op">(</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>, res <span class="op">=</span> <span class="fl">96</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Figure <a href="basic-reactivity.html#fig:sim-button2-react">3.15</a> shows the new reactive graph.
Note that, as desired, <code>x1</code> and <code>x2</code> no longer have a reactive dependency on <code>lambda1</code>, <code>lambda2</code>, and <code>n</code>: changing their values will not trigger computation.
I left the arrows in very pale grey just to remind you that <code>x1</code> and <code>x2</code> continue to use the values, but no longer take a reactive dependency on them.</p>
<div class="figure">
<span style="display:block;" id="fig:sim-button2-react"></span>
<img src="diagrams/basic-reactivity/timing-button-2.png" alt="`eventReactive()` makes it possible to separate the dependencies (black arrows) from the values used to compute the result (pale gray arrows)." width="416"><p class="caption">
Figure 3.15: <code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">eventReactive()</a></code> makes it possible to separate the dependencies (black arrows) from the values used to compute the result (pale gray arrows).
</p>
</div>
</div>
</div>
<div id="observers" class="section level2" number="3.6">
<h2>
<span class="header-section-number">3.6</span> Observers<a class="anchor" aria-label="anchor" href="#observers"><i class="fas fa-link"></i></a>
</h2>
<p>So far, we’ve focused on what’s happening inside the app.
But sometimes you need to reach outside of the app and cause side-effects to happen elsewhere in the world.
This might be saving a file to a shared network drive, sending data to a web API, updating a database, or (most commonly) printing a debugging message to the console.
These actions don’t affect how your app looks, so you shouldn’t use an output and a <code>render</code> function.
Instead you need to use an <strong>observer</strong>.</p>
<p>There are multiple ways to create an observer, and we’ll come back to them later in Section <a href="#observers-details"><strong>??</strong></a>.
For now, I wanted to show you how to use <code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent()</a></code>, because it gives you an important debugging tool when you’re first learning Shiny.</p>
<p><code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent()</a></code> is very similar to <code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">eventReactive()</a></code>.
It has two important arguments: <code>eventExpr</code> and <code>handlerExpr</code>.
The first argument is the input or expression to take a dependency on; the second argument is the code that will be run.
For example, the following modification to <code>server()</code> means that every time that <code>name</code> is updated, a message will be sent to the console:</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/fluidPage.html">fluidPage</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textInput.html">textInput</a></span><span class="op">(</span><span class="st">"name"</span>, <span class="st">"What's your name?"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/textOutput.html">textOutput</a></span><span class="op">(</span><span class="st">"greeting"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">string</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/reactive.html">reactive</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Hello "</span>, <span class="va">input</span><span class="op">$</span><span class="va">name</span>, <span class="st">"!"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">greeting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/renderPrint.html">renderText</a></span><span class="op">(</span><span class="fu">string</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">name</span>, <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Greeting performed"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>There are two important differences between <code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent()</a></code> and <code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">eventReactive()</a></code>:</p>
<ul>
<li>You don’t assign the result of <code><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html">observeEvent()</a></code> to a variable, so</li>
<li>You can’t refer to it from other reactive consumers.</li>
</ul>
<p>Observers and outputs are closely related.
You can think of outputs as having a special side-effect: updating the HTML in the user’s browser.
To emphasise this closeness, we’ll draw them the same way in the reactive graph.
This yields the following reactive graph shown in Figure <a href="basic-reactivity.html#fig:observer">3.16</a>.</p>
<div class="figure">
<span style="display:block;" id="fig:observer"></span>
<img src="diagrams/basic-reactivity/graph-3.png" alt="In the reactive graph, an observer looks the same as an output" width="306"><p class="caption">
Figure 3.16: In the reactive graph, an observer looks the same as an output
</p>
</div>
</div>
<div id="summary-2" class="section level2" number="3.7">
<h2>
<span class="header-section-number">3.7</span> Summary<a class="anchor" aria-label="anchor" href="#summary-2"><i class="fas fa-link"></i></a>
</h2>
<p>This chapter should have improved your understanding of the backend of Shiny apps, the <code>server()</code> code that responds to user actions.
You’ve also taken the first steps in mastering the reactive programming paradigm that underpins Shiny.
What you’ve learned here will carry you a long way; we’ll come back to the underlying theory in Chapter <a href="#reactive-motivation"><strong>??</strong></a>.
Reactivity is extremely powerful, but it is also very different to the imperative style of R programming that you’re most used to.
Don’t be surprised if it takes a while for all the consequences to sink in.</p>
<p>This chapter concludes our overview of the foundations of Shiny.
The next chapter will help you practice the material you’ve seen so far by creating a bigger Shiny app designed to support a data analysis.</p>

</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="basic-ui.html"><span class="header-section-number">2</span> Basic UI</a></div>
<div class="next"><a href="basic-case-study.html"><span class="header-section-number">4</span> Case study: ER injuries</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#basic-reactivity"><span class="header-section-number">3</span> Basic reactivity</a></li>
<li><a class="nav-link" href="#introduction-2"><span class="header-section-number">3.1</span> Introduction</a></li>
<li>
<a class="nav-link" href="#the-server-function"><span class="header-section-number">3.2</span> The server function</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#input"><span class="header-section-number">3.2.1</span> Input</a></li>
<li><a class="nav-link" href="#output"><span class="header-section-number">3.2.2</span> Output</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#reactive-programming"><span class="header-section-number">3.3</span> Reactive programming</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#imperative-vs-declarative-programming"><span class="header-section-number">3.3.1</span> Imperative vs declarative programming</a></li>
<li><a class="nav-link" href="#laziness"><span class="header-section-number">3.3.2</span> Laziness</a></li>
<li><a class="nav-link" href="#the-reactive-graph"><span class="header-section-number">3.3.3</span> The reactive graph</a></li>
<li><a class="nav-link" href="#reactive-expressions"><span class="header-section-number">3.3.4</span> Reactive expressions</a></li>
<li><a class="nav-link" href="#execution-order"><span class="header-section-number">3.3.5</span> Execution order</a></li>
<li><a class="nav-link" href="#exercises-3"><span class="header-section-number">3.3.6</span> Exercises</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#reactive-expressions-1"><span class="header-section-number">3.4</span> Reactive expressions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#the-motivation"><span class="header-section-number">3.4.1</span> The motivation</a></li>
<li><a class="nav-link" href="#the-app"><span class="header-section-number">3.4.2</span> The app</a></li>
<li><a class="nav-link" href="#the-reactive-graph-1"><span class="header-section-number">3.4.3</span> The reactive graph</a></li>
<li><a class="nav-link" href="#simplifying-the-graph"><span class="header-section-number">3.4.4</span> Simplifying the graph</a></li>
<li><a class="nav-link" href="#reactive-roadblocks"><span class="header-section-number">3.4.5</span> Why do we need reactive expressions?</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#controlling-timing-of-evaluation"><span class="header-section-number">3.5</span> Controlling timing of evaluation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#timed-invalidation"><span class="header-section-number">3.5.1</span> Timed invalidation</a></li>
<li><a class="nav-link" href="#on-click"><span class="header-section-number">3.5.2</span> On click</a></li>
</ul>
</li>
<li><a class="nav-link" href="#observers"><span class="header-section-number">3.6</span> Observers</a></li>
<li><a class="nav-link" href="#summary-2"><span class="header-section-number">3.7</span> Summary</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/mastering-shiny/blob/master/basic-reactivity.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/mastering-shiny/edit/master/basic-reactivity.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Mastering Shiny</strong>" was written by Hadley Wickham. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
